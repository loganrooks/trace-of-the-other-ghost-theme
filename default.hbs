<!DOCTYPE html>
<html lang="{{@site.locale}}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{meta_title}}</title>
    
    <link rel="canonical" href="{{url absolute="true"}}">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    {{!-- Google Fonts --}}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    {{!-- Main theme styles --}}
    <link rel="stylesheet" type="text/css" href="{{asset "css/main.css"}}">
    <link rel="stylesheet" type="text/css" href="{{asset "css/hacker-effects.css"}}">
    <link rel="stylesheet" type="text/css" href="{{asset "css/digital-talmud.css"}}">
    <link rel="stylesheet" type="text/css" href="{{asset "css/footnote-themes.css"}}">
    {{#if @custom.enable_deconstruction}}
    <link rel="stylesheet" type="text/css" href="{{asset "css/deconstruction.css"}}">
    {{/if}}
    
    {{!-- Ghost head outputs meta tags and structured data --}}
    {{ghost_head}}
</head>
<body class="{{body_class}}">
    <div class="site-wrapper">
        <header class="site-header">
            <div class="site-header-content">
                <h1 class="site-title">
                    <a href="{{@site.url}}">{{@site.title}}</a>
                </h1>
                {{#if @site.description}}
                <p class="site-description">{{@site.description}}</p>
                {{/if}}
                <nav class="site-nav">
                    {{navigation}}
                </nav>
            </div>
        </header>

        <main class="site-main">
            {{{body}}}
        </main>

        <footer class="site-footer">
            <div class="site-footer-content">
                <p>&copy; {{date format="YYYY"}} {{@site.title}}</p>
                <p>Powered by <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a></p>
            </div>
        </footer>
    </div>

    
    {{!-- Content Enhancement System - Modular Architecture --}}
    {{!-- Load in dependency order for proper initialization --}}
    
    {{!-- Pass Ghost theme settings to JavaScript --}}
    <script>
        // Make Ghost custom theme settings available to JavaScript
        window.ghost_custom_settings = {
            // Visual Theme
            primary_accent_color: '{{@custom.primary_accent_color}}' || '#00ff00',
            extension_accent_color: '{{@custom.extension_accent_color}}' || '#ff8800',
            interactive_text_color: '{{@custom.interactive_text_color}}' || '#ff0000',
            hyperlink_color: '{{@custom.hyperlink_color}}' || '#00a8ff',
            
            // Footnote Settings
            enable_modern_footnotes: {{#if @custom.enable_modern_footnotes}}true{{else}}false{{/if}},
            tooltip_bg_opacity: '{{@custom.tooltip_bg_opacity}}' || '0.95',
            tooltip_max_width: '{{@custom.tooltip_max_width}}' || '400px',
            
            // Extensions
            enable_extensions: {{#if @custom.enable_extensions}}true{{else}}false{{/if}},
            
            // Interactive Features
            enable_deconstruction: {{#if @custom.enable_deconstruction}}true{{else}}false{{/if}},
            interactive_bg_opacity: '{{@custom.interactive_bg_opacity}}' || '0.8',
            animation_speed: '{{@custom.animation_speed}}' || 'normal',
            
            // Accessibility
            enable_keyboard_navigation: {{#if @custom.enable_keyboard_navigation}}true{{else}}false{{/if}},
            mobile_responsive: {{#if @custom.mobile_responsive}}true{{else}}false{{/if}},
            
            // Developer Options
            debug_mode: {{#if @custom.debug_mode}}true{{else}}false{{/if}}
        };
        
        // Apply theme colors as CSS custom properties
        document.documentElement.style.setProperty('--footnote-accent', window.ghost_custom_settings.primary_accent_color);
        document.documentElement.style.setProperty('--extension-accent', window.ghost_custom_settings.extension_accent_color);
        document.documentElement.style.setProperty('--hyperlink-color', window.ghost_custom_settings.hyperlink_color);
        
        // Apply hyperlink styles
        const linkStyles = document.createElement('style');
        linkStyles.textContent = `
            .post-content a, .page-content a,
            .footnote-tooltip a, 
            .typing-overlay a,
            .interactive-overlay a {
                color: ${window.ghost_custom_settings.hyperlink_color};
                text-decoration: underline;
                transition: all 0.2s ease;
            }
            .post-content a:hover, .page-content a:hover,
            .footnote-tooltip a:hover,
            .typing-overlay a:hover,
            .interactive-overlay a:hover {
                color: #ffffff;
                text-shadow: 0 0 8px ${window.ghost_custom_settings.hyperlink_color};
            }
            /* Preserve italic/bold formatting in tooltips */
            .footnote-tooltip em, .footnote-tooltip i {
                font-style: italic;
            }
            .footnote-tooltip strong, .footnote-tooltip b {
                font-weight: bold;
            }
        `;
        document.head.appendChild(linkStyles);
    </script>
    
    {{!-- ==============================================
         UNIFIED CONTENT ENHANCEMENT SYSTEM
         Full working system PLUS Interactive Markers
         ============================================== --}}
    
    {{!-- 1. Configuration (single source of truth) --}}
    <script src="{{asset "js/config/theme-config.js"}}"></script>
    
    {{!-- 2. Core Foundation (required) --}}
    <script src="{{asset "js/utils/bracket-parser.js"}}"></script>
    <script src="{{asset "js/utils/link-fixer.js"}}"></script>
    <script src="{{asset "js/core/content-processor-base.js"}}"></script>
    <script src="{{asset "js/core/configuration-manager.js"}}"></script>
    <script src="{{asset "js/core/target-selector.js"}}"></script>
    <script src="{{asset "js/core/action-engine.js"}}"></script>
    
    {{!-- 2b. NEW ARCHITECTURAL COMPONENTS (implementing ARCHITECTURAL_OVERHAUL_PLAN.md) --}}
    <script src="{{asset "js/core/theme-system-coordinator.js"}}"></script>
    <script src="{{asset "js/services/footnote-service.js"}}"></script>
    <script src="{{asset "js/testing/regression-tests.js"}}"></script>
    
    {{!-- 3. Animation Modules (MUST load before processors that use them) --}}
    <script src="{{asset "js/animations/typing-animation.js"}}"></script>
    <script src="{{asset "js/animations/typing-animation-v2.js"}}"></script>
    
    {{!-- 4. Content Processors (MUST load before manager) --}}
    {{!-- Processing order: deconstruction -> footnotes -> marginalia -> extensions -> interactive --}}
    {{#if @custom.enable_deconstruction}}
    <script src="{{asset "js/processors/deconstruction-processor.js"}}"></script>
    {{/if}}
    <script src="{{asset "js/processors/footnote-processor.js"}}"></script>
    <script src="{{asset "js/processors/marginalia-processor.js"}}"></script>
    {{#if @custom.enable_extensions}}
    <script src="{{asset "js/processors/paragraph-extension-processor.js"}}"></script>
    {{/if}}
    <script src="{{asset "js/interactive-marker-processor.js"}}"></script>
    
    {{!-- 5. Content Enhancement Manager (loads AFTER processors) --}}
    <script src="{{asset "js/core/content-enhancement-manager.js"}}"></script>
    
    {{!-- Script failure debug (must load before architectural-implementation) --}}
    <script src="{{asset "js/debug/script-failure-debug.js"}}"></script>
    
    {{!-- NEW ARCHITECTURE IMPLEMENTATION (must load BEFORE old system initialization) --}}
    <script src="{{asset "js/core/architectural-implementation.js"}}"></script>
    
    {{!-- 6. Robust Initialization (handles initialization with error recovery) --}}
    <script src="{{asset "js/core/initialization.js"}}"></script>
    
    {{!-- 7. Emergency Debug (always loads for troubleshooting) --}}
    <script src="{{asset "js/debug/emergency-debug.js"}}"></script>
    <script src="{{asset "js/debug/script-execution-debug.js"}}"></script>
    <script src="{{asset "js/debug/deconstruction-pipeline-debug.js"}}"></script>
    <script src="{{asset "js/debug/deconstruction-effects-debug.js"}}"></script>
    <script src="{{asset "js/debug/deconstruction-css-debug.js"}}"></script>
    <script src="{{asset "js/debug/automatic-processing-debug.js"}}"></script>
    <script src="{{asset "js/debug/deconstruction-only-debug.js"}}"></script>
    <script src="{{asset "js/debug/config-debug.js"}}"></script>
    <script src="{{asset "js/debug/debug-loader-test.js"}}"></script>
    <script src="{{asset "js/debug/interactive-marker-debug.js"}}"></script>
    <script src="{{asset "js/debug/simple-typing-debug.js"}}"></script>
    <script src="{{asset "js/debug/emergency-footnote-diagnostic.js"}}"></script>
    <script src="{{asset "js/debug/debug-control.js"}}"></script>
    <script src="{{asset "js/debug/white-box-diagnostic.js"}}"></script>
    <script src="{{asset "js/debug/console-access-validator.js"}}"></script>
    <script src="{{asset "js/debug/config-inspection.js"}}"></script>
    <script src="{{asset "js/debug/system-conflict-resolver.js"}}"></script>
    <script src="{{asset "js/debug/architecture-detection-debug.js"}}"></script>
    <script src="{{asset "js/debug/href-format-diagnostic.js"}}"></script>
    
    {{!-- 8. Effects (stable theme effects only) --}}
    <script src="{{asset "js/effects/hacker-effects.js"}}"></script>
    
    {{!-- 9. Debug Tools (development only) --}}
    {{#if @custom.debug_mode}}
    <script src="{{asset "js/debug/debug-logger.js"}}"></script>
    <script src="{{asset "js/debug/system-diagnostic.js"}}"></script>
    <script src="{{asset "js/debug/deconstruction-debugger.js"}}"></script>
    {{/if}}
    
    {{ghost_foot}}
</body>
</html>
